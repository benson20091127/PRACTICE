<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>ä¿®ä»™åŠ‡æƒ… - ä¿®ä»™æ–‡å­—éŠæˆ²</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700&family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
    <style>
    /* æ–‡å­—ç‰¹æ•ˆ */
    .fade-in { animation: fadeIn 1s; }
    @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
    .flash { animation: flashAnim 0.6s; }
    @keyframes flashAnim { 0%{background:#fffbe6;} 50%{background:#ffe066;} 100%{background:transparent;} }
    
    /* å‡ç´šè¦–è¦ºæ•ˆæœ */
    body.flash { animation: levelUpFlash 0.6s; }
    @keyframes levelUpFlash { 
        0%{background-color:rgba(255,255,255,0);} 
        50%{background-color:rgba(255,215,0,0.2);} 
        100%{background-color:rgba(255,255,255,0);} 
    }
    
    /* æ•…äº‹å°è©±æ¡†æ¨£å¼ */
    .story-dialogue {
        background: rgba(248, 244, 230, 0.95);
        border: 2px solid #bfa76f;
        border-radius: 20px;
        padding: 20px;
        margin: 15px 0;
        box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }
    
    .character-name {
        font-size: 1.2rem;
        font-weight: bold;
        color: #7c5c2b;
        margin-bottom: 8px;
        border-bottom: 1px dashed #bfa76f;
        padding-bottom: 5px;
    }
    
    .dialogue-text {
        font-size: 1.15rem;
        line-height: 1.8;
        color: #5a4a2a;
        font-style: italic;
    }
    
    .story-context {
        background: rgba(255, 250, 230, 0.8);
        border-left: 4px solid #bfa76f;
        padding: 15px 20px;
        margin: 15px 0;
        border-radius: 0 15px 15px 0;
        font-size: 1.1rem;
        color: #6b5b3d;
    }
    
    .choice-result {
        background: rgba(230, 255, 230, 0.9);
        border: 1px solid #90c695;
        border-radius: 15px;
        padding: 15px;
        margin: 10px 0;
        font-size: 1.05rem;
        color: #2d5a2d;
    }
    
    .choice-consequence {
        background: rgba(255, 240, 240, 0.9);
        border: 1px solid #e6a3a3;
        border-radius: 15px;
        padding: 15px;
        margin: 10px 0;
        font-size: 1.05rem;
        color: #8b2635;
    }
    
    body {
        background: linear-gradient(135deg, #f8f4e6 0%, #e6d9b3 100%);
        background-image: url('https://www.transparenttextures.com/patterns/cream-paper.png');
        font-family: "Ma Shan Zheng", "Noto Serif TC", "STKaiti", "å¾®è»Ÿæ­£é»‘é«”", serif;
        font-size: 1.2rem;
    }
    .story-main {
        background: rgba(255,255,240,0.98);
        border-radius: 32px;
        border: 5px solid #bfa76f;
        box-shadow: 0 16px 64px rgba(120,100,60,0.18);
        padding: 48px 36px 36px 36px;
        position: relative;
        overflow: hidden;
        background-image: url('https://svgshare.com/i/13vA.svg');
        background-repeat: no-repeat;
        background-size: 120px 120px;
        background-position: top left;
    }
    .story-title {
        font-size: 2.5rem;
        font-family: "Ma Shan Zheng", "Noto Serif TC", "STKaiti", "å¾®è»Ÿæ­£é»‘é«”", serif;
        color: #7c5c2b;
        text-shadow: 2px 2px 16px #e6d9b3, 0 0 2px #fff;
        letter-spacing: 4px;
        margin-bottom: 30px;
        animation: fadeIn 1.2s;
        border-bottom: 2px dashed #bfa76f;
        padding-bottom: 8px;
        text-align: center;
    }
    .points-indicator, .life-indicator, .level-indicator {
        display: inline-block;
        min-width: 130px;
        font-size: 1.1rem;
        color: #bfa76f;
        background: rgba(255,255,240,0.85);
        border: 2px solid #bfa76f;
        border-radius: 16px;
        padding: 8px 16px;
        box-shadow: 0 2px 16px rgba(180,180,180,0.12);
        font-weight: bold;
        font-family: "Ma Shan Zheng", "Noto Serif TC", serif;
        white-space: nowrap;
        text-align: center;
        margin: 0 5px;
    }
    .btn, .btn-outline-primary, .btn-outline-secondary, .btn-outline-danger {
        border-radius: 24px;
        font-family: "Ma Shan Zheng", "Noto Serif TC", serif;
        font-size: 1.1rem;
        letter-spacing: 2px;
        box-shadow: 0 2px 12px rgba(180,180,180,0.15);
        border-width: 2px;
        transition: transform 0.2s, box-shadow 0.2s;
        padding: 10px 20px;
    }
    .btn-outline-primary {
        border-color: #bfa76f;
        color: #7c5c2b;
        background: linear-gradient(90deg,#fffbe6 60%,#e6d9b3 100%);
    }
    .btn-outline-primary:hover {
        background: #e6d9b3;
        color: #fff;
        transform: scale(1.05);
        box-shadow: 0 4px 24px rgba(120,180,255,0.25);
    }
    .btn-outline-secondary, .btn-outline-danger {
        border-color: #bfa76f;
        color: #7c5c2b;
        background: #f8f4e6;
    }
    .btn-outline-secondary:hover, .btn-outline-danger:hover {
        background: #bfa76f;
        color: #fff;
    }
    .cloud-svg {
        position: absolute;
        left: -40px; top: -60px;
        width: 180px; height: 120px;
        opacity: 0.18;
        z-index: 0;
        pointer-events: none;
    }
    .cloud-svg2 {
        position: absolute;
        right: -60px; bottom: -40px;
        width: 140px; height: 90px;
        opacity: 0.13;
        z-index: 0;
        pointer-events: none;
    }
    .tips-box {
        position: fixed;
        right: 30px;
        bottom: 30px;
        min-width: 200px;
        max-width: 300px;
        background: rgba(255,255,240,0.96);
        border: 2px solid #bfa76f;
        border-radius: 18px;
        box-shadow: 0 4px 24px rgba(120,120,120,0.10);
        padding: 16px 20px;
        color: #7c5c2b;
        font-size: 1.1rem;
        font-family: "Noto Serif TC", "Ma Shan Zheng", serif;
        z-index: 99;
        text-align: left;
        pointer-events: none;
        opacity: 0.9;
    }
    .tips-box-title {
        font-weight: bold;
        font-size: 1.1rem;
        margin-bottom: 6px;
        letter-spacing: 2px;
        color: #bfa76f;
    }
    #story {
        min-height: 60px;
        font-family: "Ma Shan Zheng", "Noto Serif TC", "STKaiti", "å¾®è»Ÿæ­£é»‘é«”", serif;
        font-size: 1.3rem;
        color: #7c5c2b;
        letter-spacing: 1.5px;
        line-height: 1.8;
        margin-bottom: 25px;
    }
    .story-text {
        font-family: "Ma Shan Zheng", "Noto Serif TC", "STKaiti", "å¾®è»Ÿæ­£é»‘é«”", serif;
        font-size: 1.3rem;
        color: #7c5c2b;
        letter-spacing: 1.5px;
        line-height: 1.8;
    }
    #choices {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 15px;
        margin-bottom: 0;
        padding: 0 10px;
    }
    .story-choice-btn {
        flex: 1 1 160px;
        min-width: 120px;
        max-width: 240px;
        margin-bottom: 10px;
        white-space: normal;
        word-break: keep-all;
        font-size: 1.1rem;
    }
    @media (max-width: 768px) {
        .tips-box { right: 15px; bottom: 15px; min-width: 180px; font-size: 1rem; }
        .points-indicator, .life-indicator, .level-indicator { min-width: 100px; font-size: 1rem; margin: 2px; }
        .story-choice-btn { flex: 1 1 120px; min-width: 100px; font-size: 1rem; }
        .story-title { font-size: 2rem; }
        #story, .story-text { font-size: 1.2rem; }
    }
    </style>
</head>
<body class="bg-light">
<!-- å¤é¢¨é›²éœ§SVGè£é£¾ -->
<svg class="cloud-svg" viewBox="0 0 180 120"><path fill="#bfa76f" d="M20,60 Q60,10 120,40 Q170,80 100,100 Q40,120 20,60 Z"/></svg>
<svg class="cloud-svg2" viewBox="0 0 140 90"><path fill="#bfa76f" d="M10,40 Q40,10 100,30 Q130,60 70,80 Q20,90 10,40 Z"/></svg>

<div class="container d-flex justify-content-center align-items-center" style="min-height:100vh; padding-top:40px; padding-bottom:40px;">
    <div class="story-main w-100" style="max-width:650px;margin:20px auto;position:relative;">
        <div class="story-title">ä¿®ä»™æ–‡å­—å†’éšª</div>
        
        <div class="d-flex justify-content-center align-items-center flex-wrap mb-4">
            <div class="points-indicator" id="pointsIndicator">é»æ•¸ï¼šè¼‰å…¥ä¸­...</div>
            <div class="life-indicator" id="lifeIndicator">å£½å‘½ï¼šè¼‰å…¥ä¸­...</div>
            <div class="level-indicator" id="levelIndicator">ç­‰ç´šï¼šè¼‰å…¥ä¸­...</div>
        </div>
        
        <div class="d-flex justify-content-center gap-3 mb-3 flex-wrap">
            <a href="shop.html" class="btn btn-outline-secondary">è¿”å›å•†åŸ</a>
            <a href="inventory.html" class="btn btn-outline-primary">æŸ¥çœ‹èƒŒåŒ…</a>
            <button class="btn btn-outline-danger" onclick="logout()">ç™»å‡º</button>
        </div>
        
        <div id="story" class="text-center"></div>
        <div id="choices"></div>
    </div>
</div>

<!-- ä¿®ä»™å°æç¤ºæµ®å‹•å€å¡Š -->
<div id="tipsBox" class="tips-box">
    <div class="tips-box-title">ä¿®ä»™å°æç¤º</div>
    <div>è¼‰å…¥ä¸­...</div>
</div>

<script>
let userItems = [];
let isDead = false;
let hasTicket = false;
let points = 0;
let life = 30;
let userLevel = 1;
let userExp = 0;
let deathPenalty = 500;

function fetchInventory(cb){
    fetch('inventory.php')
    .then(res=>res.json())
    .then(data=>{
        userItems = data.items || [];
        hasTicket = userItems.some(x=>x.name==='çµå±€åˆ¸');
        calcLifeAndEquip();
        cb && cb();
    });
}

function fetchPoints(cb){
    fetch('shop.php')
    .then(res=>res.json())
    .then(data=>{
        points = data.points || 0;
        userLevel = data.level || 1;
        userExp = data.exp || 0;
        updatePointsIndicator();
        updateLevelIndicator();
        cb && cb();
    });
}

function updatePointsIndicator(val){
    if(val !== undefined) points = val;
    document.getElementById('pointsIndicator').innerHTML = 'é»æ•¸ï¼š' + points.toLocaleString();
}

function updateLifeIndicator(){
    document.getElementById('lifeIndicator').innerHTML = 'å£½å‘½ï¼š' + life;
}

function updateLevelIndicator(){
    document.getElementById('levelIndicator').innerHTML = 'Lv.' + userLevel;
}

function addPoints(amount, callback){
    fetch('add_points.php', {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body:'amount='+amount
    })
    .then(res=>res.json())
    .then(data=>{
        updatePointsIndicator(data.points ?? (points+amount));
        callback && callback();
    });
}

function losePoints(amount, callback){
    fetch('add_points.php', {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body:'amount=' + (-amount)
    })
    .then(res=>res.json())
    .then(data=>{
        updatePointsIndicator(data.points ?? (points-amount));
        callback && callback();
    });
}

function addLife(amount){
    life += amount;
    updateLifeIndicator();
}

function loseLife(amount){
    life -= amount;
    if(life < 0) life = 0;
    updateLifeIndicator();
}

function addExp(amount, callback) {
    if(!amount || amount <= 0) {
        callback && callback();
        return;
    }
    
    fetch('level_system.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: 'add_exp=1&exp_amount=' + amount
    })
    .then(res => res.json())
    .then(data => {
        if(data.status === 1) {
            userLevel = data.level;
            userExp = data.exp;
            updateLevelIndicator();
            
            if(data.level_result && data.level_result.leveled_up) {
                showLevelUpMessage(data.level_result.old_level, data.level_result.new_level);
                setTimeout(() => {
                    const levelBonus = data.level_result.new_level * 50;
                    addPoints(levelBonus, () => {
                        const story = document.getElementById('story');
                        story.innerHTML += `<div class="alert alert-info mt-2 fade-in">ğŸ’° å‡ç´šçå‹µï¼šç²å¾— ${levelBonus} å•†åŸé»æ•¸ï¼</div>`;
                        callback && callback();
                    });
                }, 1500);
                return;
            }
        }
        callback && callback();
    })
    .catch(err => {
        console.error('ç¶“é©—å€¼æ›´æ–°å¤±æ•—:', err);
        callback && callback();
    });
}

function showLevelUpMessage(oldLevel, newLevel) {
    const story = document.getElementById('story');
    story.innerHTML += `<div class="alert alert-success mt-3 fade-in">ğŸ‰ æ­å–œï¼ä¿®ç‚ºçªç ´ï¼å¾ Lv.${oldLevel} å‡ç´šåˆ° Lv.${newLevel}ï¼</div>`;
    document.body.classList.add('flash');
    setTimeout(() => document.body.classList.remove('flash'), 800);
}

function getRandom(min, max){
    return Math.floor(Math.random() * (max-min+1)) + min;
}

function calcLifeAndEquip(){
    let atk = 0, def = 0, lvl = 0;
    userItems.forEach(i=>{
        atk += parseInt(i.attack||0);
        def += parseInt(i.defense||0);
        lvl += parseInt(i.level||0);
    });
    window._equipBonus = {atk, def, lvl};
}

const eventPool = {
    0: [
        {
            text: 'ä½ åœ¨å±±è°·é‡åˆ°ç¥ç§˜è€äººï¼Œä»–é‚€ä½ å“èŒ—è«–é“ï¼Œé‚„æœ‰ä¸€æ¢å°å¾‘é€šå¾€æ·±å±±ã€‚ä½ æœƒï¼Ÿ',
            choices: [
                {label:'è«‹æ•™è€äººä¿®ä»™', next:1, event:'adventure'},
                {label:'èˆ‡è€äººå“èŒ—', next:0, event:'rest'},
                {label:'èµ°å°å¾‘é€²å±±', next:2, event:'explore'},
                {label:'åŸåœ°æ‰“å', next:0, event:'rest'}
            ]
        },
        {
            text: 'ä½ åœ¨ç«¹æ—ç™¼ç¾ä¸€æœ¬å¤ç±ï¼Œæ—é‚Šæœ‰ä¸€éš»ç™½é¶´ã€‚ä½ æœƒï¼Ÿ',
            choices: [
                {label:'ç¿»é–±å¤ç±', next:3, event:'explore'},
                {label:'è§€å¯Ÿç™½é¶´', next:0, event:'explore'},
                {label:'æ‰“åå†¥æƒ³', next:0, event:'rest'}
            ]
        }
    ],
    1: [
        {
            text: 'å±±è°·é›²æ·±ä¸çŸ¥è™•ï¼Œçªç„¶å‡ºç¾å¦–ç¸ã€‚ä½ æœƒï¼Ÿ',
            choices: [
                {label:'è¿æˆ°å¦–ç¸', next:4, event:'fight'},
                {label:'é€ƒé›¢å±±è°·', next:0, event:'rest'}
            ]
        }
    ],
    2: [
        {
            text: 'ç«¹æ—ä¸­ä¿ å®¢é‚€ä½ åˆ‡ç£‹æ­¦è—ã€‚ä½ æœƒï¼Ÿ',
            choices: [
                {label:'åˆ‡ç£‹æ­¦è—', next:5, event:'fight'},
                {label:'å©‰æ‹’åˆ‡ç£‹', next:0, event:'rest'}
            ]
        }
    ],
    3: [
        {
            text: 'æºªé‚Šç™½é¶´èµ·èˆï¼Œæ°´ä¸­æœ‰é­šã€‚ä½ æœƒï¼Ÿ',
            choices: [
                {label:'é è¿‘ç™½é¶´', next:0, event:'explore'},
                {label:'é‡£é­š', next:0, event:'explore'},
                {label:'éœè§€å…¶è®Š', next:0, event:'rest'}
            ]
        }
    ],
    4: [
        {
            text: 'ä½ èˆ‡å¦–ç¸æ¿€æˆ°ï¼Œæ˜¯å¦å…¨åŠ›å‡ºæ‹›ï¼Ÿ',
            choices: [
                {label:'å…¨åŠ›å‡ºæ‹›', next:1, event:'fight'},
                {label:'æ’¤é€€', next:0, event:'rest'}
            ]
        }
    ],
    5: [
        {
            text: 'ä¿ å®¢ä½¿å‡ºç„éµé‡åŠï¼Œæ˜¯å¦è¿æˆ°ï¼Ÿ',
            choices: [
                {label:'è¿æˆ°', next:2, event:'fight'},
                {label:'è¦‹å¥½å°±æ”¶', next:0, event:'rest'}
            ]
        }
    ]
};

// å¦–å…½æ•°æ®åº“ - 30ç§å¦–å…½
const beastDatabase = [
    // åˆçº§å¦–å…½ (ç­‰çº§1-3)
    {name: 'é‡‘ç¥çœŸèŸ¾', level: 1, reward: {exp: 50, points: 200}, dropRate: 0.1},
    {name: 'æª®æŒ', level: 2, reward: {exp: 80, points: 350}, dropRate: 0.12},
    {name: 'çª®å¥‡', level: 2, reward: {exp: 100, points: 400}, dropRate: 0.15},
    {name: 'ä¹å°¾ç‹', level: 3, reward: {exp: 120, points: 500}, dropRate: 0.18},
    {name: 'é¥•é¤®', level: 3, reward: {exp: 150, points: 600}, dropRate: 0.2},
    
    // ä¸­çº§å¦–å…½ (ç­‰çº§4-6)
    {name: 'æ··æ²Œ', level: 4, reward: {exp: 200, points: 800}, dropRate: 0.22},
    {name: 'æ¢¼æŒ', level: 4, reward: {exp: 220, points: 900}, dropRate: 0.25},
    {name: 'ç™½æ¾¤', level: 5, reward: {exp: 280, points: 1200}, dropRate: 0.28},
    {name: 'å¤”ç‰›', level: 5, reward: {exp: 300, points: 1350}, dropRate: 0.3},
    {name: 'é³³å‡°', level: 6, reward: {exp: 400, points: 1800}, dropRate: 0.32},
    
    // é«˜çº§å¦–å…½ (ç­‰çº§7-9)
    {name: 'é’é¾', level: 7, reward: {exp: 500, points: 2500}, dropRate: 0.35},
    {name: 'ç™½è™', level: 7, reward: {exp: 520, points: 2600}, dropRate: 0.35},
    {name: 'æœ±é›€', level: 8, reward: {exp: 600, points: 3200}, dropRate: 0.38},
    {name: 'ç„æ­¦', level: 8, reward: {exp: 650, points: 3500}, dropRate: 0.4},
    {name: 'éº’éºŸ', level: 9, reward: {exp: 800, points: 4500}, dropRate: 0.42},
    
    // ç¥çº§å¦–å…½ (ç­‰çº§10-12)
    {name: 'ç‡­é¾', level: 10, reward: {exp: 1000, points: 6000}, dropRate: 0.45},
    {name: 'æ‡‰é¾', level: 10, reward: {exp: 1100, points: 6500}, dropRate: 0.45},
    {name: 'é¾ç‹', level: 11, reward: {exp: 1300, points: 8000}, dropRate: 0.48},
    {name: 'é¯¤éµ¬', level: 11, reward: {exp: 1400, points: 8500}, dropRate: 0.5},
    {name: 'å¤ªå¤é¾çš‡', level: 12, reward: {exp: 1800, points: 12000}, dropRate: 0.52},
    
    // ä¸Šå¤å‡¶å…½ (ç­‰çº§13-15)
    {name: 'æ··æ²Œåå¤©ç¸', level: 13, reward: {exp: 2200, points: 15000}, dropRate: 0.55},
    {name: 'è™›ç©ºå™¬é­‚è›‡', level: 13, reward: {exp: 2400, points: 16000}, dropRate: 0.55},
    {name: 'æ»…ä¸–é­”ç‹¼', level: 14, reward: {exp: 2800, points: 20000}, dropRate: 0.58},
    {name: 'å¼’ç¥é­”é¾', level: 14, reward: {exp: 3000, points: 22000}, dropRate: 0.6},
    {name: 'å‰µä¸–ç¥ç¸', level: 15, reward: {exp: 4000, points: 35000}, dropRate: 0.65},
    
    // ä¼ è¯´å¦–å…½ (ç‰¹æ®Š)
    {name: 'ä¸Šå¤é­”ç¥', level: 20, reward: {exp: 8000, points: 80000}, dropRate: 0.8},
    {name: 'æ··å…ƒå§‹ç¥–', level: 25, reward: {exp: 15000, points: 150000}, dropRate: 0.9},
    {name: 'å¤©é“åŒ–èº«', level: 30, reward: {exp: 30000, points: 300000}, dropRate: 0.95},
    {name: 'ç„¡æ¥µå¤©é­”', level: 35, reward: {exp: 50000, points: 500000}, dropRate: 1.0},
    {name: 'å‰µä¸–ä¹‹éˆ', level: 50, reward: {exp: 100000, points: 1000000}, dropRate: 1.0}
];

// æ ¹æ®ç©å®¶ç­‰çº§è·å–åˆé€‚çš„å¦–å…½
function getRandomBeast() {
    const suitableBeasts = beastDatabase.filter(beast => 
        beast.level <= userLevel + 3 && beast.level >= Math.max(1, userLevel - 2)
    );
    
    if (suitableBeasts.length === 0) {
        return beastDatabase[0]; // è¿”å›æœ€ä½çº§å¦–å…½
    }
    
    return suitableBeasts[Math.floor(Math.random() * suitableBeasts.length)];
}

// å¦–å…½æˆ˜æ–—ç»“æœè®¡ç®—
function calculateBeastBattle(beast, action) {
    let equip = window._equipBonus || {atk:0, def:0, lvl:0};
    let playerPower = userLevel * 10 + equip.atk + equip.def + equip.lvl;
    let beastPower = beast.level * 15;
    
    let baseChance = 0.5; // åŸºç¡€èƒœç‡50%
    let powerRatio = playerPower / beastPower;
    let winChance = baseChance * powerRatio;
    
    if (action === 'fight') {
        // æˆ˜æ–—ï¼šé£é™©æ›´é«˜ä½†æ”¶ç›Šæ›´å¤§
        let deathRate = Math.max(0.1, 0.3 - (equip.def * 0.01) - (userLevel * 0.01));
        if (Math.random() < deathRate) {
            return {result: 'death', reason: `è¢«${beast.name}æ’•ç¢åå™¬`};
        }
        
        if (Math.random() < winChance) {
            // èƒœåˆ©
            let expGain = beast.reward.exp + getRandom(50, 150);
            let pointsGain = beast.reward.points + getRandom(100, 500);
            let itemDrop = Math.random() < beast.dropRate;
            
            return {
                result: 'victory',
                beast: beast,
                exp: expGain,
                points: pointsGain,
                item: itemDrop ? getRandomItem() : null
            };
        } else {
            // å¤±è´¥ä½†å­˜æ´»
            let lifeLoss = getRandom(5, 15);
            let pointsLoss = getRandom(200, 800);
            return {
                result: 'defeat',
                beast: beast,
                lifeLoss: lifeLoss,
                pointsLoss: pointsLoss
            };
        }
    } else {
        // é€ƒé¿ï¼šé£é™©è¾ƒä½ä½†å¯èƒ½å¤±è´¥
        let escapeChance = 0.7 + (userLevel * 0.02);
        let deathRate = Math.max(0.05, 0.15 - (equip.def * 0.008));
        
        if (Math.random() < deathRate) {
            return {result: 'death', reason: `é€ƒè·‘æ—¶è¢«${beast.name}è¿½ä¸Šå‡»æ€`};
        }
        
        if (Math.random() < escapeChance) {
            return {result: 'escape_success', beast: beast};
        } else {
            // é€ƒè·‘å¤±è´¥ï¼Œå—åˆ°ä¼¤å®³
            let lifeLoss = getRandom(3, 10);
            let pointsLoss = getRandom(100, 400);
            return {
                result: 'escape_fail',
                beast: beast,
                lifeLoss: lifeLoss,
                pointsLoss: pointsLoss
            };
        }
    }
}

// ä¿®æ”¹åŸæœ‰äº‹ä»¶ç³»ç»Ÿï¼Œå¢åŠ å¦–å…½é­é‡
function getRandomEvent(type){
    let equip = window._equipBonus || {atk:0, def:0, lvl:0};
    let r = Math.random();
    loseLife(1);
    
    // å¢åŠ å¦–å…½é­é‡æœºç‡
    let beastEncounterRate = 0.25; // 25%æœºç‡é‡åˆ°å¦–å…½
    if (Math.random() < beastEncounterRate) {
        return {type: 'beast_encounter', beast: getRandomBeast()};
    }
    
    let deathRate = 0.08;
    deathRate -= equip.lvl*0.008 + equip.def*0.003 + equip.atk*0.002;
    if(deathRate < 0.02) deathRate = 0.02;
    
    if(type==='adventure'){
        if(r<deathRate) return {type:'death', reason:'åº¦åŠ«å¤±æ•—ï¼Œå¤©é›·è½Ÿé ‚'};
        if(r<deathRate+0.25) return {type:'points', amount:getRandom(150,300)};
        if(r<deathRate+0.32) return {type:'item', name:getRandomItem()};
        if(r<deathRate+0.42) return {type:'buff', buff:'life', amount:getRandom(3,8)};
        if(r<deathRate+0.52) return {type:'buff', buff:'points', amount:getRandom(80,180)};
        if(r<deathRate+0.68) return {type:'elixir'};
        return {type:'peace'};
    }
    if(type==='fight'){
        let fightDeath = deathRate+0.05;
        if(r<fightDeath) return {type:'death', reason:'æˆ°é¬¥ä¸­åŠ›ç«­è€Œäº¡'};
        if(r<fightDeath+0.25) return {type:'points', amount:getRandom(200,400)};
        if(r<fightDeath+0.32) return {type:'item', name:getRandomItem()};
        if(r<fightDeath+0.40) return {type:'buff', buff:'life', amount:getRandom(4,10)};
        if(r<fightDeath+0.63) return {type:'elixir'};
        return {type:'peace'};
    }
    if(type==='explore'){
        if(r<0.05) return {type:'death', reason:'èª¤å…¥éšªå¢ƒï¼Œæ„å¤–èº«äº¡'};
        if(r<0.22) return {type:'points', amount:getRandom(80,180)};
        if(r<0.30) return {type:'item', name:getRandomItem()};
        if(r<0.38) return {type:'buff', buff:'life', amount:getRandom(2,6)};
        if(r<0.52) return {type:'elixir'};
        return {type:'peace'};
    }
    if(type==='rest'){
        if(r<0.03) return {type:'death', reason:'èµ°ç«å…¥é­”ï¼Œå¿ƒç¥ä¿±æ»…'};
        if(r<0.20) return {type:'buff', buff:'life', amount:getRandom(2,6)};
        if(r<0.28) return {type:'elixir'};
        return {type:'peace'};
    }
    if(type==='elixir'){
        if(r<0.70) return {type:'buff', buff:'life', amount:getRandom(6,15)};
        return {type:'elixir'};
    }
    return {type:'peace'};
}

function getRandomItem() {
    const items = ['ç¥é¶´ä»¤', 'ç„éµé‡åŠ', 'ç™½é¶´ç¾½è¡£', 'è­·èº«ç¬¦', 'èšæ°£ç '];
    return items[Math.floor(Math.random() * items.length)];
}

function addItem(itemName, callback){
    fetch('shop.php')
    .then(res=>res.json())
    .then(data=>{
        let item = (data.products||[]).find(p=>p.name===itemName);
        if(item){
            fetch('shop.php', {
                method:'POST',
                headers:{'Content-Type':'application/x-www-form-urlencoded'},
                body:'buy=1&product_id='+item.product_id
            }).then(()=>{
                fetchInventory(callback);
            });
        }else{
            callback && callback();
        }
    });
}

function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]] = [arr[j],arr[i]];
    }
    return arr;
}

function handleDeath(reason) {
    losePoints(deathPenalty, () => {
        document.getElementById('story').innerHTML =
            (reason ? `<span class="text-danger story-text">${reason}</span><br>` : '') +
            '<div class="story-text">ä½ å£½å…ƒå·²ç›¡ï¼Œé­‚æ­¸ä¹å¤©ã€‚<br>' +
            `<span class="text-danger fw-bold">ã€æ­»äº¡çµå±€ã€‘</span><br>` +
            `<span class="text-warning">å•†åŸé»æ•¸æ‰£é™¤${deathPenalty}é»ä½œç‚ºæ‡²ç½°</span></div>`;
        document.getElementById('choices').innerHTML =
            '<a href="shop.html" class="btn btn-success mt-3">å›å•†åŸå†æº–å‚™</a>';
    });
}

// æ–°çš„æ•…äº‹äº‹ä»¶ç³»çµ± - åŒ…å«è±å¯Œçš„å°è©±å’ŒåŠ‡æƒ…
const storyEvents = {
    // ç¥ç§˜è€äººç³»åˆ—
    mysteriousElder: {
        title: "ç¥ç§˜è€äºº",
        stages: [
            {
                context: "ä½ åœ¨å¹½æ·±çš„å±±è°·ä¸­è¡Œèµ°ï¼Œéœ§æ°£ç¹šç¹ã€‚å¿½ç„¶ï¼Œä¸€ä½é¶´é«®ç«¥é¡çš„è€äººå‡ºç¾åœ¨ä½ é¢å‰ï¼Œä»–èº«ç©¿é“è¢ï¼Œæ‰‹æŒæ‹‚å¡µã€‚",
                character: "ç¥ç§˜è€äºº",
                dialogue: "å¹´è¼•çš„ä¿®ä»™è€…ï¼Œæˆ‘è§€ä½ éª¨éª¼æ¸…å¥‡ï¼Œé —æœ‰ä»™ç·£ã€‚ä¸éä¿®ä»™ä¹‹è·¯å…‡éšªè¬åˆ†ï¼Œä½ å¯é¡˜æ„æ¥å—æˆ‘çš„è€ƒé©—ï¼Ÿ",
                choices: [
                    {
                        text: "æ­æ•¬è«‹æ•™ï¼Œé¡˜å—è€ƒé©—",
                        nextStage: 1,
                        type: "respectful"
                    },
                    {
                        text: "ç›´æ¥è©¢å•æœ‰ä½•å¥½è™•",
                        nextStage: 2,
                        type: "pragmatic"
                    },
                    {
                        text: "æ‡·ç–‘è€äººèº«ä»½ï¼Œä¿æŒè­¦æƒ•",
                        nextStage: 3,
                        type: "cautious"
                    }
                ]
            },
            {
                // æ­æ•¬è·¯ç·š
                context: "è€äººæ»¿æ„åœ°é»äº†é»é ­ï¼Œçœ¼ä¸­éœ²å‡ºè®šè¨±ä¹‹è‰²ã€‚",
                character: "ç¥ç§˜è€äºº",
                dialogue: "å¾ˆå¥½ï¼è¬™éœä¹ƒä¿®ä»™ç¬¬ä¸€è¦ç¾©ã€‚æˆ‘é€™è£¡æœ‰ä¸‰æ¨£æ±è¥¿ï¼Œä½ å¯é¸å…¶ä¸€ï¼šä¸€æ˜¯å¢é•·å£½å…ƒçš„éˆä¸¹ï¼ŒäºŒæ˜¯æå‡ä¿®ç‚ºçš„å¿ƒæ³•ï¼Œä¸‰æ˜¯è­·èº«çš„æ³•å¯¶ã€‚",
                choices: [
                    {
                        text: "é¸æ“‡éˆä¸¹",
                        reward: {type: "life", amount: 20},
                        exp: 80,
                        result: "choice_result"
                    },
                    {
                        text: "é¸æ“‡å¿ƒæ³•",
                        reward: {type: "exp", amount: 150},
                        exp: 50,
                        result: "choice_result"
                    },
                    {
                        text: "é¸æ“‡æ³•å¯¶",
                        reward: {type: "item", name: "è­·èº«ç¬¦"},
                        exp: 60,
                        result: "choice_result"
                    }
                ]
            },
            {
                // åŠŸåˆ©è·¯ç·š
                context: "è€äººçšºèµ·çœ‰é ­ï¼Œè‡‰è‰²ç•¥é¡¯ä¸æ‚…ã€‚",
                character: "ç¥ç§˜è€äºº",
                dialogue: "ä¿®ä»™è€…ç•¶æ·¡æ³Šååˆ©ï¼Œä½ å¦‚æ­¤åŠŸåˆ©å¿ƒé‡ï¼Œææ€•é›£æˆå¤§å™¨ã€‚ä¸éå¿µä½ å¹´è¼•ï¼Œæˆ‘çµ¦ä½ ä¸€æ¬¡æ©Ÿæœƒè¨¼æ˜è‡ªå·±ã€‚",
                choices: [
                    {
                        text: "èª å¿ƒé“æ­‰ï¼Œæ”¹æ­£æ…‹åº¦",
                        nextStage: 4,
                        type: "redemption"
                    },
                    {
                        text: "å …æŒå·±è¦‹ï¼Œæ“šç†åŠ›çˆ­",
                        nextStage: 5,
                        type: "stubborn"
                    }
                ]
            },
            {
                // è­¦æƒ•è·¯ç·š
                context: "è€äººå“ˆå“ˆå¤§ç¬‘ï¼Œçœ¼ä¸­ç²¾å…‰é–ƒçˆã€‚",
                character: "ç¥ç§˜è€äºº",
                dialogue: "ä¸éŒ¯ä¸éŒ¯ï¼ä¿®ä»™è·¯ä¸Šè™•è™•é™·é˜±ï¼Œä½ èƒ½ä¿æŒè­¦æƒ•å¯¦å±¬é›£å¾—ã€‚æ—¢ç„¶å¦‚æ­¤ï¼Œæˆ‘å°±çµ¦ä½ ä¸€å€‹çœŸæ­£çš„è€ƒé©—ã€‚",
                choices: [
                    {
                        text: "æ¥å—è€ƒé©—",
                        nextStage: 6,
                        type: "challenge"
                    },
                    {
                        text: "ç¦®è²Œæ‹’çµ•é›¢é–‹",
                        reward: {type: "points", amount: 100},
                        exp: 40,
                        result: "safe_exit"
                    }
                ]
            },
            {
                // æ•‘è´–è·¯ç·š
                context: "è€äººè¦‹ä½ èª å¿ƒæ‚”æ”¹ï¼Œè¡¨æƒ…ç·©å’Œä¸‹ä¾†ã€‚",
                character: "ç¥ç§˜è€äºº",
                dialogue: "å­ºå­å¯æ•™ä¹Ÿï¼çŸ¥éŒ¯èƒ½æ”¹ï¼Œå–„è«å¤§ç„‰ã€‚æˆ‘é€ä½ ä¸€é¡†æ´—é«“ä¸¹ï¼ŒåŠ©ä½ è„«èƒæ›éª¨ã€‚",
                choices: [
                    {
                        text: "æ„Ÿæ¿€æ¥å—",
                        reward: {type: "life", amount: 15},
                        exp: 100,
                        result: "choice_result"
                    }
                ]
            },
            {
                // å›ºåŸ·è·¯ç·š
                context: "è€äººæ–é ­å˜†æ¯ï¼Œèº«å½±é€æ¼¸æ¨¡ç³Šã€‚",
                character: "ç¥ç§˜è€äºº",
                dialogue: "æ—¢ç„¶ä½ å¦‚æ­¤å›ºåŸ·å·±è¦‹ï¼Œé‚£å°±åšåšè‹¦æœå§ï¼ä¿®ä»™è·¯ä¸Šï¼Œé©•å‚²ä¹ƒå¤§æ•µï¼",
                choices: [
                    {
                        text: "æ‰¿å—å¾Œæœ",
                        consequence: {type: "points", amount: 200},
                        exp: 30,
                        result: "consequence"
                    }
                ]
            },
            {
                // æŒ‘æˆ°è·¯ç·š
                context: "è€äººæå‡ºä¸‰å€‹éŒ¦å›Šï¼Œæ¯å€‹éƒ½æ•£ç™¼è‘—ä¸åŒçš„æ°£æ¯ã€‚",
                character: "ç¥ç§˜è€äºº",
                dialogue: "é€™ä¸‰å€‹éŒ¦å›Šï¼Œä¸€å€‹è—è‘—æ©Ÿé‡ï¼Œä¸€å€‹è—è‘—å±éšªï¼Œä¸€å€‹ç©ºç„¡ä¸€ç‰©ã€‚ä½ çš„é¸æ“‡å°‡æ±ºå®šä½ çš„å‘½é‹ã€‚",
                choices: [
                    {
                        text: "é¸æ“‡å·¦é‚ŠéŒ¦å›Š",
                        challenge: "luck_test",
                        success: {type: "points", amount: 500},
                        failure: {type: "life", amount: 10},
                        exp: 80
                    },
                    {
                        text: "é¸æ“‡ä¸­é–“éŒ¦å›Š",
                        challenge: "luck_test",
                        success: {type: "item", name: "ç¥é¶´ä»¤"},
                        failure: {type: "points", amount: 300},
                        exp: 80
                    },
                    {
                        text: "é¸æ“‡å³é‚ŠéŒ¦å›Š",
                        challenge: "luck_test",
                        success: {type: "life", amount: 25},
                        failure: {type: "empty"},
                        exp: 80
                    }
                ]
            }
        ]
    },
    
    // åŠå®¢å°æ±ºç³»åˆ—
    swordsman: {
        title: "åŠå®¢å°æ±º",
        stages: [
            {
                context: "ç«¹æ—æ·±è™•ï¼Œä¸€ä½èº«ç©¿ç™½è¡£çš„åŠå®¢ç›¤è†è€Œåï¼Œèº«é‚Šæ’è‘—ä¸€æŠŠæ³›è‘—å¯’å…‰çš„é•·åŠã€‚è½åˆ°è…³æ­¥è²ï¼Œä»–ç·©ç·©çœé–‹çœ¼ç›ã€‚",
                character: "ç™½è¡£åŠå®¢",
                dialogue: "ä¾†è€…ä½•äººï¼Ÿæ­¤è™•æ˜¯æˆ‘çš„ä¿®ç·´ä¹‹åœ°ï¼Œä½ è‹¥ç„¡äº‹ï¼Œé‚„è«‹é€Ÿé€Ÿé›¢å»ã€‚è‹¥æ˜¯æƒ³è¨æ•™åŠæ³•ï¼Œæˆ‘å€’ä¸ä»‹æ„æŒ‡é»ä¸€äºŒã€‚",
                choices: [
                    {
                        text: "è«‹æ±‚æŒ‡é»åŠæ³•",
                        nextStage: 1,
                        type: "learn"
                    },
                    {
                        text: "æŒ‘æˆ°åŠå®¢",
                        nextStage: 2,
                        type: "challenge"
                    },
                    {
                        text: "è©¢å•æ­¤åœ°ç§˜å¯†",
                        nextStage: 3,
                        type: "explore"
                    },
                    {
                        text: "ç«‹å³é›¢é–‹",
                        reward: {type: "points", amount: 50},
                        exp: 20,
                        result: "safe_exit"
                    }
                ]
            },
            {
                // å­¸ç¿’è·¯ç·š
                context: "åŠå®¢ç«™èµ·èº«ä¾†ï¼Œæ‹”å‡ºé•·åŠã€‚åŠå…‰å¦‚æ°´ï¼Œåœ¨é™½å…‰ä¸‹é–ƒé–ƒç™¼äº®ã€‚",
                character: "ç™½è¡£åŠå®¢",
                dialogue: "å¾ˆå¥½ï¼è¬™éœå¥½å­¸ä¹ƒæ­¦è€…ç¾å¾·ã€‚æˆ‘é€™å°±æ¼”ç¤ºä¸€å¥—åŸºç¤åŠæ³•ï¼Œä½ éœ€ä»”ç´°è§€å¯Ÿï¼Œèƒ½é ˜æ‚Ÿå¤šå°‘å°±çœ‹ä½ çš„å¤©è³¦äº†ã€‚",
                choices: [
                    {
                        text: "å…¨ç¥è²«æ³¨è§€å¯Ÿ",
                        challenge: "comprehension_test",
                        success: {type: "points", amount: 300, message: "ä½ å®Œå…¨é ˜æ‚Ÿäº†åŠæ³•ç²¾é«“ï¼"},
                        failure: {type: "points", amount: 150, message: "ä½ é ˜æ‚Ÿäº†ä¸€äº›åŸºæœ¬æ‹›å¼ã€‚"},
                        exp: 100
                    },
                    {
                        text: "é‚Šçœ‹é‚Šæ¨¡ä»¿",
                        challenge: "skill_test",
                        success: {type: "item", name: "ç„éµé‡åŠ", message: "åŠå®¢è¦‹ä½ å¤©è³¦ç•°ç¨Ÿï¼Œè´ˆä½ å¯¶åŠï¼"},
                        failure: {type: "life", amount: 5, message: "ä½ å› å‹•ä½œéŒ¯èª¤è€Œå—å‚·ã€‚"},
                        exp: 120
                    }
                ]
            },
            {
                // æŒ‘æˆ°è·¯ç·š
                context: "åŠå®¢çœ¼ä¸­é–ƒéä¸€çµ²æ®ºæ„ï¼Œæ…¢æ…¢ç«™èµ·èº«ä¾†ã€‚",
                character: "ç™½è¡£åŠå®¢",
                dialogue: "å“¦ï¼Ÿå¹´è¼•äººè†½å­ä¸å°ã€‚ä¸éæˆ‘å¯è¦æé†’ä½ ï¼Œæˆ‘çš„åŠå¯ä¸é•·çœ¼ç›ã€‚æ—¢ç„¶ä½ ä¸»å‹•æŒ‘æˆ°ï¼Œé‚£å°±åˆ¥æ€ªæˆ‘æ‰‹ä¸‹ç„¡æƒ…äº†ï¼",
                choices: [
                    {
                        text: "å…¨åŠ›æ‡‰æˆ°",
                        challenge: "combat_test",
                        success: {type: "points", amount: 800, message: "ä½ æˆ°å‹äº†åŠå®¢ï¼Œåè²å¤§éœ‡ï¼"},
                        failure: {type: "death", reason: "è¢«åŠå®¢ä¸€åŠç©¿å¿ƒè€Œæ­»"},
                        exp: 200
                    },
                    {
                        text: "ä»¥é˜²ç‚ºä¸»",
                        challenge: "defense_test",
                        success: {type: "points", amount: 400, message: "ä½ çš„é˜²å®ˆè®“åŠå®¢åˆ®ç›®ç›¸çœ‹ï¼"},
                        failure: {type: "life", amount: 15, message: "ä½ å—äº†é‡å‚·ä½†ä¿ä½æ€§å‘½ã€‚"},
                        exp: 150
                    },
                    {
                        text: "èªè¼¸æŠ•é™",
                        nextStage: 4,
                        type: "surrender"
                    }
                ]
            },
            {
                // æ¢ç´¢è·¯ç·š
                context: "åŠå®¢ç¥è‰²è®Šå¾—ç¥ç§˜èµ·ä¾†ï¼Œæœ›å‘ç«¹æ—æ·±è™•ã€‚",
                character: "ç™½è¡£åŠå®¢",
                dialogue: "ä½ å¾ˆæ•éŠ³ã€‚é€™ç«¹æ—æ·±è™•ç¢ºå¯¦è—è‘—ç§˜å¯†...å‚³èªªæœ‰ä¸€åº§å¤å¢“ï¼ŒåŸ‹è‘¬è‘—ä¸Šå¤åŠä»™ã€‚ä¸éé‚£è£¡ä¹Ÿå……æ»¿å±éšªã€‚",
                choices: [
                    {
                        text: "è«‹æ±‚å¸¶è·¯",
                        nextStage: 5,
                        type: "guided"
                    },
                    {
                        text: "ç¨è‡ªæ¢ç´¢",
                        nextStage: 6,
                        type: "solo"
                    },
                    {
                        text: "æ”¾æ£„æ¢ç´¢",
                        reward: {type: "points", amount: 100},
                        exp: 50,
                        result: "safe_exit"
                    }
                ]
            },
            {
                // æŠ•é™è·¯ç·š
                context: "åŠå®¢æ”¶èµ·æ®ºæ„ï¼Œé»äº†é»é ­ã€‚",
                character: "ç™½è¡£åŠå®¢",
                dialogue: "çŸ¥é€²é€€è€…ç‚ºæ™ºè€…ã€‚ä½ é›–ç„¶å¯¦åŠ›ä¸è¶³ï¼Œä½†é —æœ‰è‡ªçŸ¥ä¹‹æ˜ã€‚æˆ‘é€ä½ ä¸€æœ¬åŠè­œï¼Œå¥½å¥½ä¿®ç·´å§ã€‚",
                choices: [
                    {
                        text: "æ„Ÿè¬æ¥å—",
                        reward: {type: "points", amount: 200},
                        exp: 80,
                        result: "choice_result"
                    }
                ]
            }
        ]
    },
    
    // ç¥ç§˜æ´ç©´ç³»åˆ—
    mysteriousCave: {
        title: "ç¥ç§˜æ´ç©´",
        stages: [
            {
                context: "å±±å´–é‚Šï¼Œä½ ç™¼ç¾äº†ä¸€å€‹è¢«è—¤è”“é®è“‹çš„æ´ç©´ã€‚æ´å£æ•£ç™¼è‘—æ·¡æ·¡çš„éˆæ°£ï¼Œä½†ä¹Ÿæœ‰éš±éš±çš„å±éšªæ°£æ¯ã€‚",
                character: "å…§å¿ƒç¨ç™½",
                dialogue: "é€™æ´ç©´çœ‹èµ·ä¾†å¾ˆå¤è€ï¼Œèªªä¸å®šæœ‰ä»€éº¼å¯¶è—ã€‚ä½†é€™ç¨®åœ°æ–¹å¾€å¾€ä¹Ÿå¾ˆå±éšª...",
                choices: [
                    {
                        text: "å°å¿ƒé€²å…¥æ´ç©´",
                        nextStage: 1,
                        type: "cautious"
                    },
                    {
                        text: "å¤§è†½ç›´æ¥é€²å…¥",
                        nextStage: 2,
                        type: "bold"
                    },
                    {
                        text: "å…ˆè§€å¯Ÿä¸€é™£",
                        nextStage: 3,
                        type: "observe"
                    },
                    {
                        text: "é›¢é–‹æ­¤è™•",
                        reward: {type: "points", amount: 30},
                        exp: 15,
                        result: "safe_exit"
                    }
                ]
            },
            {
                // å°å¿ƒè·¯ç·š
                context: "ä½ å°å¿ƒç¿¼ç¿¼åœ°é€²å…¥æ´ç©´ï¼Œæ¯ä¸€æ­¥éƒ½æ ¼å¤–è¬¹æ…ã€‚çªç„¶ï¼Œä½ ç™¼ç¾åœ°é¢ä¸Šæœ‰å¤è€çš„ç¬¦æ–‡ã€‚",
                character: "å…§å¿ƒç¨ç™½",
                dialogue: "é€™äº›ç¬¦æ–‡...çœ‹èµ·ä¾†åƒæ˜¯æŸç¨®å°å°ã€‚æˆ‘æ‡‰è©²å¦‚ä½•è™•ç†ï¼Ÿ",
                choices: [
                    {
                        text: "ä»”ç´°ç ”ç©¶ç¬¦æ–‡",
                        challenge: "wisdom_test",
                        success: {type: "item", name: "èšæ°£ç ", message: "ä½ ç ´è§£äº†å°å°ï¼Œç²å¾—äº†å¯¶ç‰©ï¼"},
                        failure: {type: "points", amount: 150, message: "ä½ è§¸ç™¼äº†é™·é˜±ä½†å®‰å…¨è„«èº«ã€‚"},
                        exp: 120
                    },
                    {
                        text: "ç¹éç¬¦æ–‡ç¹¼çºŒ",
                        nextStage: 4,
                        type: "bypass"
                    }
                ]
            },
            {
                // å¤§è†½è·¯ç·š
                context: "ä½ å¤§æ­¥æµæ˜Ÿåœ°é€²å…¥æ´ç©´ï¼Œçªç„¶è…³ä¸‹ä¸€ç©ºï¼",
                character: "å…§å¿ƒç¨ç™½",
                dialogue: "ç³Ÿç³•ï¼é€™æ˜¯é™·é˜±ï¼",
                choices: [
                    {
                        text: "é‹åŠŸè¼•èº«",
                        challenge: "agility_test",
                        success: {type: "points", amount: 400, message: "ä½ æˆåŠŸè„«éšªï¼Œé‚„ç™¼ç¾äº†éš±è—å¯¶ç®±ï¼"},
                        failure: {type: "life", amount: 12, message: "ä½ å—äº†å‚·ä½†ä¿ä½æ€§å‘½ã€‚"},
                        exp: 100
                    },
                    {
                        text: "ç¡¬æ‰›å‚·å®³",
                        consequence: {type: "life", amount: 8},
                        reward: {type: "points", amount: 200},
                        exp: 80,
                        result: "mixed"
                    }
                ]
            }
        ]
    }
};

// æŒ‘æˆ°æ¸¬è©¦ç³»çµ±
function runChallenge(challengeType, playerChoice, successReward, failureReward, exp) {
    let equip = window._equipBonus || {atk:0, def:0, lvl:0};
    let baseSuccessRate = 0.5;
    let playerBonus = 0;
    
    switch(challengeType) {
        case 'luck_test':
            baseSuccessRate = 0.4;
            playerBonus = userLevel * 0.02;
            break;
        case 'comprehension_test':
            baseSuccessRate = 0.6;
            playerBonus = userLevel * 0.03 + equip.lvl * 0.02;
            break;
        case 'skill_test':
            baseSuccessRate = 0.5;
            playerBonus = equip.atk * 0.02 + userLevel * 0.02;
            break;
        case 'combat_test':
            baseSuccessRate = 0.3;
            playerBonus = equip.atk * 0.03 + equip.def * 0.02 + userLevel * 0.02;
            break;
        case 'defense_test':
            baseSuccessRate = 0.7;
            playerBonus = equip.def * 0.04 + userLevel * 0.02;
            break;
        case 'wisdom_test':
            baseSuccessRate = 0.6;
            playerBonus = equip.lvl * 0.03 + userLevel * 0.03;
            break;
        case 'agility_test':
            baseSuccessRate = 0.5;
            playerBonus = userLevel * 0.02 + equip.atk * 0.01;
            break;
    }
    
    let finalSuccessRate = Math.min(0.95, baseSuccessRate + playerBonus);
    let success = Math.random() < finalSuccessRate;
    
    return {
        success: success,
        reward: success ? successReward : failureReward,
        exp: exp
    };
}

// é¡¯ç¤ºæ•…äº‹äº‹ä»¶
function showStoryEvent(eventKey, stageIndex = 0) {
    if(isDead || life <= 0) {
        handleDeath();
        return;
    }
    
    const event = storyEvents[eventKey];
    if(!event || !event.stages[stageIndex]) {
        showStory(0); // å›åˆ°æ™®é€šäº‹ä»¶
        return;
    }
    
    const stage = event.stages[stageIndex];
    loseLife(1);
    updateLifeIndicator();
    
    let storyHTML = `<div class="story-title">${event.title}</div>`;
    
    if(stage.context) {
        storyHTML += `<div class="story-context">${stage.context}</div>`;
    }
    
    if(stage.dialogue && stage.character) {
        storyHTML += `
            <div class="story-dialogue">
                <div class="character-name">${stage.character}</div>
                <div class="dialogue-text">"${stage.dialogue}"</div>
            </div>
        `;
    }
    
    document.getElementById('story').innerHTML = storyHTML;
    document.getElementById('story').className = 'fade-in';
    
    const choicesDiv = document.getElementById('choices');
    choicesDiv.innerHTML = '';
    
    stage.choices.forEach(choice => {
        const btn = document.createElement('button');
        btn.className = 'btn btn-outline-primary mb-2 story-choice-btn';
        btn.innerText = choice.text;
        btn.onclick = () => handleStoryChoice(eventKey, stageIndex, choice);
        choicesDiv.appendChild(btn);
    });
}

// è™•ç†æ•…äº‹é¸æ“‡
function handleStoryChoice(eventKey, stageIndex, choice) {
    if(isDead || life <= 0) {
        handleDeath();
        return;
    }
    
    // å¦‚æœæœ‰ä¸‹ä¸€éšæ®µï¼Œé¡¯ç¤ºä¸‹ä¸€éšæ®µ
    if(choice.nextStage !== undefined) {
        showStoryEvent(eventKey, choice.nextStage);
        return;
    }
    
    // å¦‚æœæœ‰æŒ‘æˆ°
    if(choice.challenge) {
        const challengeResult = runChallenge(
            choice.challenge,
            choice,
            choice.success,
            choice.failure,
            choice.exp
        );
        
        let resultHTML = '';
        if(challengeResult.success) {
            resultHTML = `<div class="choice-result">æˆåŠŸï¼${choice.success.message || ''}</div>`;
        } else {
            resultHTML = `<div class="choice-consequence">å¤±æ•—ï¼${choice.failure.message || ''}</div>`;
        }
        
        document.getElementById('story').innerHTML += resultHTML;
        
        // æ‡‰ç”¨çµæœ
        applyEventResult(challengeResult.reward, challengeResult.exp);
        return;
    }
    
    // ç›´æ¥çå‹µ
    if(choice.reward) {
        let resultHTML = `<div class="choice-result">ä½ çš„é¸æ“‡å¸¶ä¾†äº†å›å ±ï¼</div>`;
        document.getElementById('story').innerHTML += resultHTML;
        applyEventResult(choice.reward, choice.exp);
        return;
    }
    
    // è² é¢å¾Œæœ
    if(choice.consequence) {
        let resultHTML = `<div class="choice-consequence">ä½ çš„é¸æ“‡å¸¶ä¾†äº†å¾Œæœ...</div>`;
        document.getElementById('story').innerHTML += resultHTML;
        applyEventResult(choice.consequence, choice.exp, true);
        return;
    }
    
    // æ··åˆçµæœ
    if(choice.result === 'mixed') {
        document.getElementById('story').innerHTML += `<div class="choice-result">é›–ç„¶å—äº†å‚·ï¼Œä½†ä¹Ÿæœ‰æ‰€æ”¶ç©«ã€‚</div>`;
        loseLife(choice.consequence.amount);
        addPoints(choice.reward.amount, () => {
            addExp(choice.exp, () => {
                setTimeout(() => showStory(0), 2000);
            });
        });
        return;
    }
    
    // å®‰å…¨é›¢é–‹
    if(choice.result === 'safe_exit') {
        document.getElementById('story').innerHTML += `<div class="choice-result">ä½ å®‰å…¨åœ°é›¢é–‹äº†ã€‚</div>`;
        applyEventResult(choice.reward, choice.exp);
        return;
    }
}

// æ‡‰ç”¨äº‹ä»¶çµæœ
function applyEventResult(reward, exp, isConsequence = false) {
    if(reward.type === 'death') {
        isDead = true;
        handleDeath(reward.reason);
        return;
    }
    
    if(reward.type === 'life') {
        if(isConsequence) {
            loseLife(reward.amount);
        } else {
            addLife(reward.amount);
        }
        updateLifeIndicator();
    }
    
    if(reward.type === 'points') {
        if(isConsequence) {
            losePoints(reward.amount, () => {
                addExp(exp, () => {
                    setTimeout(() => showStory(0), 2000);
                });
            });
        } else {
            addPoints(reward.amount, () => {
                addExp(exp, () => {
                    setTimeout(() => showStory(0), 2000);
                });
            });
        }
        return;
    }
    
    if(reward.type === 'item') {
        addItem(reward.name, () => {
            addExp(exp, () => {
                setTimeout(() => showStory(0), 2000);
            });
        });
        return;
    }
    
    if(reward.type === 'exp') {
        addExp(reward.amount + exp, () => {
            setTimeout(() => showStory(0), 2000);
        });
        return;
    }
    
    if(reward.type === 'empty') {
        document.getElementById('story').innerHTML += `<div class="choice-result">ä»€éº¼éƒ½æ²’æœ‰ç™¼ç”Ÿã€‚</div>`;
        addExp(exp, () => {
            setTimeout(() => showStory(0), 2000);
        });
        return;
    }
    
    // é»˜èªè™•ç†
    addExp(exp, () => {
        setTimeout(() => showStory(0), 2000);
    });
}

// ä¿®ä»™å°æç¤º
const tipsArr = [
    "ä¿®ä»™ä¹‹è·¯ï¼Œè²´åœ¨å …æŒèˆ‡æ‚Ÿé“ã€‚",
    "è£å‚™æå‡å¯é™ä½æ­»äº¡é¢¨éšªï¼Œè¨˜å¾—å¤šå¤šå¼·åŒ–ï¼",
    "åœ¨æ•…äº‹äº‹ä»¶ä¸­ï¼Œä½ çš„é¸æ“‡æœƒçœŸæ­£å½±éŸ¿çµæœï¼",
    "è¬™éœçš„æ…‹åº¦å¾€å¾€èƒ½ç²å¾—æ›´å¥½çš„çµæœã€‚",
    "ä¸åŒçš„é¸æ“‡æœƒè§£é–ä¸åŒçš„æ•…äº‹åˆ†æ”¯ã€‚",
    "èˆ‡NPCçš„å°è©±å¾ˆé‡è¦ï¼Œä»”ç´°è€ƒæ…®ä½ çš„å›æ‡‰ã€‚",
    "æœ‰æ™‚å€™å‹‡æ•¢é¢å°æŒ‘æˆ°æœƒæœ‰æ„æƒ³ä¸åˆ°çš„æ”¶ç©«ï¼",
    "å•†åŸåˆ†é¡å¯å¿«é€Ÿå°‹æ‰¾æ‰€éœ€è£å‚™ã€‚",
    "å£½å‘½æ­¸é›¶å³çµæŸï¼Œè«‹è¬¹æ…é¸æ“‡æ¯ä¸€æ­¥ã€‚",
    "çµå±€åˆ¸å¯åŠ©ä½ é£›æ˜‡æˆä»™ï¼Œéœ€è¦300ç´šæ‰èƒ½è³¼è²·ï¼",
    "ç­‰ç´šè¶Šé«˜ï¼Œèƒ½è³¼è²·çš„è£å‚™è¶Šå¼·ï¼",
    "é«˜ç´šè£å‚™åƒ¹æ ¼æ˜‚è²´ï¼Œéœ€è¦å¤§é‡ç©ç´¯ï¼",
    "é­é‡å¦–ç¸æ™‚ï¼Œå¯ä»¥é¸æ“‡æˆ°é¬¥ç²å¾—è±åšçå‹µï¼Œæˆ–é€ƒé¿ä¿å…¨æ€§å‘½ã€‚",
    "æ“Šæ•—å¦–ç¸æœ‰æ©Ÿç‡ç²å¾—ç¨€æœ‰è£å‚™ï¼Œä½†é¢¨éšªå¾ˆå¤§ï¼",
    "å¦–ç¸ç­‰ç´šè¶Šé«˜ï¼Œçå‹µè¶Šè±åšï¼Œä½†æ­»äº¡æ©Ÿç‡ä¹Ÿè¶Šå¤§ã€‚",
    "è£å‚™è¶Šå¼·ï¼Œåœ¨æŒ‘æˆ°ä¸­æˆåŠŸçš„æ©Ÿæœƒè¶Šå¤§ï¼",
    "æ¯å€‹æ•…äº‹äº‹ä»¶éƒ½æœ‰å¤šå€‹åˆ†æ”¯ï¼Œæ¢ç´¢ä¸åŒçš„é¸æ“‡ï¼"
];

function showRandomTip() {
    const tip = tipsArr[Math.floor(Math.random()*tipsArr.length)];
    document.getElementById('tipsBox').innerHTML =
        `<div class="tips-box-title">ä¿®ä»™å°æç¤º</div><div>${tip}</div>`;
}

// æ·»åŠ ç¼ºå¤±çš„å‡½æ•¸
function logout(){
    fetch('logout.php').then(()=>location.href='login.html');
}

function startGame(){
    life = 30; // æ¯æ¬¡é€²å…¥é‡è¨­å£½å‘½
    fetchInventory(()=>{
        fetchPoints(()=>{
            isDead = false;
            hasTicket = userItems.some(x=>x.name==='çµå±€åˆ¸');
            updateLifeIndicator();
            showStory(0);
        });
    });
}

// ä¿®æ”¹åŸæœ‰çš„showStoryå‡½æ•¸ï¼ŒåŠ å…¥æ•…äº‹äº‹ä»¶æ©Ÿç‡
function showStory(step){
    if(isDead || life <= 0){
        handleDeath();
        return;
    }
    if(hasTicket){
        document.getElementById('story').innerHTML = '<div class="story-text">ä½ æŒæœ‰çµå±€åˆ¸ï¼Œé ˜æ‚Ÿä¿®ä»™çœŸè«¦ï¼Œé£›æ˜‡æˆä»™ï¼Œæ°¸äº«é€é™ï¼<br><span class="text-success fw-bold">ã€é£›æ˜‡çµå±€ã€‘</span></div>';
        document.getElementById('choices').innerHTML = '<a href="shop.html" class="btn btn-success mt-3">å›å•†åŸ</a>';
        return;
    }
    
    // 25%æ©Ÿç‡è§¸ç™¼æ•…äº‹äº‹ä»¶
    if(Math.random() < 0.25) {
        const storyEventKeys = Object.keys(storyEvents);
        const randomEventKey = storyEventKeys[Math.floor(Math.random() * storyEventKeys.length)];
        showStoryEvent(randomEventKey, 0);
        return;
    }
    
    // 15%æ©Ÿç‡è§¸ç™¼å¦–ç¸äº‹ä»¶
    if(Math.random() < 0.15) {
        const beast = getRandomBeast();
        showBeastEncounter(beast);
        return;
    }
    
    // å¦å‰‡é¡¯ç¤ºæ™®é€šäº‹ä»¶
    let pool = eventPool[step] || eventPool[0];
    let idx = getRandom(0, pool.length-1);
    let eventObj = pool[idx];
    let storyText = eventObj.text;
    let choices = shuffle(eventObj.choices.slice());
    
    document.getElementById('story').className = 'fade-in';
    document.getElementById('story').innerHTML = `<div class="story-text">${storyText}</div>`;
    updateLifeIndicator();
    
    const choicesDiv = document.getElementById('choices');
    choicesDiv.innerHTML = '';
    choicesDiv.className = 'd-flex flex-wrap justify-content-center gap-3 choices-flex-wrap';
    
    choices.forEach(c=>{
        const btn = document.createElement('button');
        btn.className = 'btn btn-outline-primary mb-2 story-choice-btn';
        btn.innerText = c.label;
        btn.onclick = ()=>{
            if(isDead || life <= 0){
                handleDeath();
                return;
            }
            let eventResult = getRandomEvent(c.event);
            let baseExp = getRandom(5, 12);
            
            if(eventResult.type === 'beast_encounter') {
                showBeastEncounter(eventResult.beast);
                return;
            }
            
            handleNormalEvent(eventResult, baseExp, c.next);
        };
        choicesDiv.appendChild(btn);
    });
}

// æ–°å¢å¦–ç¸é­é‡é¡¯ç¤ºå‡½æ•¸
function showBeastEncounter(beast) {
    document.getElementById('story').innerHTML = `
        <div class="story-context">
            å‰æ–¹çªç„¶å‚³ä¾†é™£é™£å˜¶å¼ï¼Œä¸€éš»å…‡çŒ›çš„å¦–ç¸æ””ä½äº†ä½ çš„å»è·¯ï¼
        </div>
        <div class="story-dialogue">
            <div class="character-name">é­é‡å¦–ç¸</div>
            <div class="dialogue-text">ä¸€éš» <span style="color: #dc3545; font-size: 1.2em;">${beast.name}</span> (ç­‰ç´š ${beast.level}) å‡ºç¾åœ¨ä½ é¢å‰ï¼<br>
            <small>æ­¤å¦–ç¸å¯¦åŠ›${beast.level > userLevel ? 'é è¶…' : beast.level < userLevel ? 'é å¼±æ–¼' : 'ç›¸ç•¶æ–¼'}ä½ çš„ä¿®ç‚º</small></div>
        </div>
    `;
    
    const choicesDiv = document.getElementById('choices');
    choicesDiv.innerHTML = '';
    
    const fightBtn = document.createElement('button');
    fightBtn.className = 'btn btn-danger mb-2 story-choice-btn';
    fightBtn.innerText = 'è¿æˆ°å¦–ç¸';
    fightBtn.onclick = () => handleBeastBattle(beast, 'fight', 0, getRandom(5, 12));
    
    const escapeBtn = document.createElement('button');
    escapeBtn.className = 'btn btn-warning mb-2 story-choice-btn';
    escapeBtn.innerText = 'é€ƒé¿é›¢é–‹';
    escapeBtn.onclick = () => handleBeastBattle(beast, 'escape', 0, getRandom(5, 12));
    
    choicesDiv.appendChild(fightBtn);
    choicesDiv.appendChild(escapeBtn);
}

// åˆå§‹åŒ–éŠæˆ²
showRandomTip();
startGame();

// å¤„ç†å¦–å…½æˆ˜æ–—
function handleBeastBattle(beast, action, nextStep, baseExp) {
    const battleResult = calculateBeastBattle(beast, action);
    
    switch(battleResult.result) {
        case 'death':
            isDead = true;
            handleDeath(battleResult.reason);
            break;
            
        case 'victory':
            document.getElementById('story').innerHTML = `
                <div class="story-text">
                    <div class="alert alert-success">
                        ğŸ‰ <strong>æˆ˜æ–—èƒœåˆ©ï¼</strong><br>
                        ä½ æˆåŠŸå‡»è´¥äº† ${beast.name}ï¼<br>
                        è·å¾—ç»éªŒå€¼ï¼š${battleResult.exp}<br>
                        è·å¾—ç‚¹æ•°ï¼š${battleResult.points}
                        ${battleResult.item ? `<br>ğŸ è·å¾—ç¨€æœ‰é“å…·ï¼š${battleResult.item}` : ''}
                    </div>
                </div>
            `;
            
            // åº”ç”¨å¥–åŠ±
            addPoints(battleResult.points, () => {
                updatePointsIndicator();
                addExp(battleResult.exp, () => {
                    if (battleResult.item) {
                        addItem(battleResult.item, () => {
                            setTimeout(() => showStory(nextStep), 2000);
                        });
                    } else {
                        setTimeout(() => showStory(nextStep), 2000);
                    }
                });
            });
            break;
            
        case 'defeat':
            document.getElementById('story').innerHTML = `
                <div class="story-text">
                    <div class="alert alert-danger">
                        ğŸ’¥ <strong>æˆ˜æ–—å¤±è´¥ï¼</strong><br>
                        ä½ è¢« ${beast.name} å‡»è´¥ï¼Œèº«å—é‡ä¼¤ï¼<br>
                        å¤±å»å£½å‘½ï¼š${battleResult.lifeLoss}<br>
                        å¤±å»é»æ•¸ï¼š${battleResult.pointsLoss}
                    </div>
                </div>
            `;
            
            loseLife(battleResult.lifeLoss);
            losePoints(battleResult.pointsLoss, () => {
                updatePointsIndicator();
                addExp(baseExp, () => {
                    setTimeout(() => showStory(nextStep), 2000);
                });
            });
            break;
            
        case 'escape_success':
            document.getElementById('story').innerHTML = `
                <div class="story-text">
                    <div class="alert alert-info">
                        ğŸƒ <strong>æˆåŠŸé€ƒè„±ï¼</strong><br>
                        ä½ æˆåŠŸä» ${beast.name} é¢å‰é€ƒè„±äº†ï¼
                    </div>
                </div>
            `;
            
            addExp(baseExp, () => {
                setTimeout(() => showStory(nextStep), 1500);
            });
            break;
            
        case 'escape_fail':
            document.getElementById('story').innerHTML = `
                <div class="story-text">
                    <div class="alert alert-warning">
                        ğŸ˜° <strong>é€ƒè·‘å¤±è´¥ï¼</strong><br>
                        ${beast.name} è¿½ä¸Šäº†ä½ ï¼Œå¯¹ä½ é€ æˆäº†ä¼¤å®³ï¼<br>
                        å¤±å»å£½å‘½ï¼š${battleResult.lifeLoss}<br>
                        å¤±å»é»æ•¸ï¼š${battleResult.pointsLoss}
                    </div>
                </div>
            `;
            
            loseLife(battleResult.lifeLoss);
            losePoints(battleResult.pointsLoss, () => {
                updatePointsIndicator();
                addExp(baseExp, () => {
                    setTimeout(() => showStory(nextStep), 2000);
                });
            });
            break;
    }
}

// å¤„ç†æ™®é€šäº‹ä»¶ (ä¿æŒåŸæœ‰é€»è¾‘)
function handleNormalEvent(eventResult, baseExp, nextStep) {
    // æ ¹æ®äº‹ä»¶ç±»å‹è°ƒæ•´ç»éªŒå€¼
    switch(eventResult.event) {
        case 'adventure': baseExp += getRandom(3, 8); break;
        case 'fight': baseExp += getRandom(5, 12); break;
        case 'explore': baseExp += getRandom(2, 6); break;
        case 'rest': baseExp += getRandom(1, 4); break;
        case 'elixir': baseExp += getRandom(8, 15); break;
    }
    
    if(eventResult.type==='death'){
        if(!isDead) {
            isDead = true;
            handleDeath(eventResult.reason);
        }
        return;
    }
    if(eventResult.type==='poison'){
        document.getElementById('story').className = 'flash fade-in';
        document.getElementById('story').innerHTML = `<div class="story-text">ä½ èª¤é£Ÿæ¯’è—¥ï¼Œå£½å‘½å¤§å¹…æ¸›å°‘ï¼</div>`;
        loseLife(10);
        updateLifeIndicator();
        addExp(baseExp, () => showStory(nextStep));
        return;
    }
    if(eventResult.type==='buff'){
        document.getElementById('story').className = 'fade-in';
        if(eventResult.buff === 'life'){
            document.getElementById('story').innerHTML = `<div class="story-text">ä½ ç²å¾—å¤©åœ°éˆæ°£æ»‹é¤Šï¼Œå£½å‘½å¢åŠ ${eventResult.amount}ï¼</div>`;
            addLife(eventResult.amount);
            updateLifeIndicator();
            addExp(baseExp + getRandom(15, 30) + Math.floor(eventResult.amount * 2), () => showStory(nextStep));
        } else if(eventResult.buff === 'points'){
            document.getElementById('story').innerHTML = `<div class="story-text">ä½ å› å¥‡é‡ç²å¾—${eventResult.amount}å•†åŸé»æ•¸ï¼</div>`;
            addPoints(eventResult.amount, ()=>{
                updatePointsIndicator(points);
                addExp(baseExp + getRandom(20, 40) + Math.floor(eventResult.amount / 10), () => showStory(nextStep));
            });
        }
        return;
    }
    if(eventResult.type==='item'){
        document.getElementById('story').className = 'fade-in';
        document.getElementById('story').innerHTML = `<div class="story-text">ä½ ç²å¾—äº†ç¨€æœ‰è£å‚™ã€${eventResult.name}ã€‘ï¼</div>`;
        addItem(eventResult.name, ()=>{
            addExp(baseExp + getRandom(30, 60), () => {
                fetchInventory(()=>showStory(nextStep));
            });
        });
        return;
    }
    if(eventResult.type==='points'){
        document.getElementById('story').className = 'fade-in';
        document.getElementById('story').innerHTML = `<div class="story-text">ä½ ç²å¾—${eventResult.amount}å•†åŸé»æ•¸ï¼</div>`;
        addPoints(eventResult.amount, ()=>{
            updatePointsIndicator(points);
            addExp(baseExp + getRandom(12, 25) + Math.floor(eventResult.amount / 15), () => showStory(nextStep));
        });
        return;
    }
    if(eventResult.type==='lose'){
        document.getElementById('story').className = 'fade-in';
        document.getElementById('story').innerHTML = `<div class="story-text">ä½ å¤±å»${eventResult.amount}å•†åŸé»æ•¸...</div>`;
        losePoints(eventResult.amount, ()=>{
            updatePointsIndicator(points);
            addExp(baseExp + getRandom(8, 15), () => showStory(nextStep));
        });
        return;
    }
    if(eventResult.type==='elixir'){
        document.getElementById('story').className = 'fade-in';
        document.getElementById('story').innerHTML = `<div class="story-text">ä½ æœç”¨éˆä¸¹å¦™è—¥ï¼Œå£½å‘½å¤§å¢ï¼</div>`;
        addLife(15);
        updateLifeIndicator();
        addExp(baseExp + getRandom(40, 80), () => showStory(nextStep));
        return;
    }
    if(eventResult.type==='peace'){
        document.getElementById('story').className = 'fade-in';
        document.getElementById('story').innerHTML = `<div class="story-text">ä¸€åˆ‡é¢¨å¹³æµªéœï¼Œç„¡äº‹ç™¼ç”Ÿã€‚</div>`;
        updateLifeIndicator();
        addExp(baseExp, () => showStory(nextStep));
        return;
    }
    // å…¶é¤˜äº‹ä»¶è™•ç†
    document.getElementById('story').className = 'fade-in';
    fetchInventory(()=>{
        updateLifeIndicator();
        updatePointsIndicator(points);
        addExp(baseExp, () => showStory(nextStep));
    });
}
</script>
<script src="theme.js"></script>
</body>
</html>